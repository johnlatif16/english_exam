<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }
    
    h2 {
      color: var(--dark);
      margin: 0;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px 15px;
      text-align: left;
    }
    
    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
    
    .score-high {
      color: var(--success);
      font-weight: bold;
    }
    
    .score-medium {
      color: var(--warning);
      font-weight: bold;
    }
    
    .score-low {
      color: var(--danger);
      font-weight: bold;
    }
    
    .action-cell {
      width: 280px;
      text-align: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .hidden {
      display: none;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-allowed {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }
    
    .status-disallowed {
      background-color: rgba(220, 53, 69, 0.2);
      color: var(--danger);
    }
    
    /* Styles for questions display */
    .questions-container {
      background-color: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 10px;
      border-left: 4px solid var(--primary);
    }
    
    .question-item {
      margin-bottom: 15px;
      padding: 15px;
      background: white;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 4px solid #ddd;
    }
    
    .question-item.correct {
      border-left-color: var(--success);
    }
    
    .question-item.incorrect {
      border-left-color: var(--danger);
    }
    
    .question-text {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .answer-row {
      display: flex;
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      align-items: center;
    }
    
    .answer-correct {
      background-color: rgba(40, 167, 69, 0.1);
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    
    .answer-incorrect {
      background-color: rgba(220, 53, 69, 0.1);
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .answer-label {
      font-weight: 600;
      min-width: 150px;
      margin-right: 10px;
    }
    
    .questions-toggle {
      margin-top: 15px;
      text-align: center;
    }
    
    .questions-row {
      background-color: #f8f9fa;
    }
    
    .questions-row td {
      padding: 0;
    }
    
    .questions-content {
      padding: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>Admin Dashboard</h2>
      <div class="btn-group">
        <button class="btn-primary" onclick="loadResults()">View Results</button>
        <button class="btn-danger" onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Total Participants</div>
        <div class="stat-value" id="totalParticipants">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Score</div>
        <div class="stat-value" id="averageScore">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Highest Score</div>
        <div class="stat-value" id="highestScore">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Lowest Score</div>
        <div class="stat-value" id="lowestScore">0%</div>
      </div>
    </div>
    
    <table id="resultsTable" class="hidden">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Score (%)</th>
          <th>Correct</th>
          <th>Wrong</th>
          <th>Status</th>
          <th class="action-cell">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const token = localStorage.getItem("token");
    if (!token) {
      window.location.href = "/login.html";
    }

    // تعريف الإجابات الصحيحة
    const correctAnswers = {
      q1: "D", q2: "A", q3: "A", q4: "A", q5: "B",
      q6: "D", q7: "B", q8: "A", q9: "C", q10: "A",
      q11: "B", q12: "A", q13: "A", q14: "B", q15: "C",
      q16: "B", q17: "C", q18: "A", q19: "C", q20: "D",
      q21: "C", q22: "B", q23: "A", q24: "D", q25: "C"
    };

    // تعريف خيارات الإجابات لكل سؤال
    const answerOptions = {
      q1: { A: "exciting", B: "more exciting", C: "most exciting", D: "the most exciting" },
      q2: { A: "a lot", B: "a lot of", C: "lots of", D: "many" },
      q3: { A: "tall", B: "heavy", C: "high", D: "long" },
      q4: { A: "worse", B: "the worst", C: "more badly", D: "badly" },
      q5: { A: "more expensive", B: "expensive", C: "most expensive", D: "less expensive" },
      q6: { A: "old", B: "older", C: "eldest", D: "oldest" },
      q7: { A: "more", B: "most", C: "less", D: "as" },
      q8: { A: "more dangerous", B: "most dangerous", C: "so dangerous", D: "as dangerous" },
      q9: { A: "high", B: "higher", C: "highest", D: "highly" },
      q10: { A: "so", B: "very", C: "highly", D: "a lot" },
      q11: { A: "high", B: "higher", C: "highest", D: "highly" },
      q12: { A: "deepest", B: "deep", C: "deeper", D: "depth" },
      q13: { A: "biggest", B: "bigger", C: "big", D: "tallest" },
      q14: { A: "good", B: "better", C: "best", D: "more good" },
      q15: { A: "old", B: "young", C: "age", D: "older" },
      q16: { A: "young", B: "younger", C: "youngest", D: "more young" },
      q17: { A: "tall", B: "taller", C: "the tallest", D: "as tall" },
      q18: { A: "a little", B: "little", C: "less", D: "the least" },
      q19: { A: "highest", B: "longest", C: "tallest", D: "deepest" },
      q20: { A: "cleverer", B: "clever", C: "less clever", D: "the cleverest" },
      q21: { A: "more", B: "much", C: "the most", D: "most" },
      q22: { A: "fewer", B: "worse", C: "fewest", D: "worst" },
      q23: { A: "a lot", B: "a lot of", C: "lots of", D: "many" },
      q24: { A: "so", B: "thus", C: "very", D: "such" },
      q25: { A: "at", B: "from", C: "to", D: "in" }
    };

    // تعريف نصوص الأسئلة
    const questionTexts = {
      q1: "1. Which do you think is …………………… city in the world?",
      q2: "2. Going by plane is …………………… more expensive than going by bus.",
      q3: "3. Ali is as ………………………… as Sami. They are the same height.",
      q4: "4. Perhaps I looked bad this morning, but she looked …………… .",
      q5: "5. Cars are twice as …………………… . as they were a few years ago.",
      q6: "6. The ……………………… tree in the world is in Sweden.",
      q7: "7. Climbing is the ………………………. dangerous sport in the world.",
      q8: "8. Climbing is ………………………………. than cycling.",
      q9: "9. Everest is the …………………………… mountain in the world.",
      q10: "10. London isn't …………….. hot as Cairo.",
      q11: "11. Everest is ………………………. than Kilimanjaro.",
      q12: "12. The …………………… place in the ocean is called Challenger Deep.",
      q13: "13. The Pacific Ocean is the …………………………….ocean in the world.",
      q14: "14. The warmer the weather, the ……………………………. I feel.",
      q15: "15. Dalia is the same …………………………….. as Diana.",
      q16: "16. Sara is the ………………………….. of the two sisters.",
      q17: "17. Giraffes are ………………………………. of all animals.",
      q18: "18. Today is ………………………….. hotter than yesterday.",
      q19: "19. Ayman is the ………………………….. boy in our class.",
      q20: "20. I'm very clever at cooking, but my mother is ……… cook I've ever known.",
      q21: "21. I love all my family, but I love my father ………..….. of all.",
      q22: "22. Samy speaks French …………….….. than he writes it.",
      q23: "23. Going by plane is ………….…… more expensive than going by bus.",
      q24: "24. The teacher told us ……….…….. an interesting story.",
      q25: "25. Benha is the nearest town ………….. Cairo."
    };

    // دالة لإنشاء عرض الأسئلة والإجابات
    function createQuestionsDisplay(userAnswers) {
      if (!userAnswers || Object.keys(userAnswers).length === 0) {
        return '<div class="questions-container"><p>No answers available for this student</p></div>';
      }

      let html = '<div class="questions-container">';
      html += '<h3>Student Answers Details</h3>';
      
      Object.keys(questionTexts).forEach(questionId => {
        const userAnswer = userAnswers[questionId];
        const correctAnswer = correctAnswers[questionId];
        const isCorrect = userAnswer === correctAnswer;
        
        const userAnswerText = userAnswer ? (answerOptions[questionId][userAnswer] || 'Unknown') : 'لم يتم الإجابة';
        const correctAnswerText = answerOptions[questionId][correctAnswer];
        
        html += `
          <div class="question-item ${isCorrect ? 'correct' : 'incorrect'}">
            <div class="question-text">${questionTexts[questionId]}</div>
            <div class="answer-row ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
              <span class="answer-label">إجابة الطالب:</span>
              <span><strong>${userAnswerText}</strong> ${userAnswer ? `(${userAnswer})` : ''}</span>
            </div>
            <div class="answer-row answer-correct">
              <span class="answer-label">الإجابة الصحيحة:</span>
              <span><strong>${correctAnswerText}</strong> (${correctAnswer})</span>
            </div>
            <div class="answer-row">
              <span class="answer-label">الحالة:</span>
              <span style="color: ${isCorrect ? 'green' : 'red'}; font-weight: bold;">
                ${isCorrect ? '✓ صحيحة' : '✗ خاطئة'}
              </span>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      return html;
    }

    // دالة لعرض/إخفاء الأسئلة
    function toggleQuestions(userId, userAnswers) {
      const questionsRow = document.getElementById(`questions-${userId}`);
      
      if (questionsRow) {
        // إذا كان موجودًا بالفعل، قم بإزالته
        questionsRow.remove();
        // تغيير نص الزر إلى "اظهار"
        const button = document.querySelector(`tr[data-user-id="${userId}"] .toggle-questions-btn`);
        if (button) {
          button.textContent = 'اظهار الاسئلة بالاجابات';
        }
      } else {
        // إذا لم يكن موجودًا، قم بإنشائه وعرضه
        const row = document.createElement('tr');
        row.id = `questions-${userId}`;
        row.className = 'questions-row';
        row.innerHTML = `
          <td colspan="7">
            <div class="questions-content">
              ${createQuestionsDisplay(userAnswers)}
              <div class="questions-toggle">
                <button class="btn-info" onclick="toggleQuestions('${userId}', ${JSON.stringify(userAnswers).replace(/'/g, "\\'")})">اخفاء الأسئلة</button>
              </div>
            </div>
          </td>
        `;
        
        // إدراج الصف بعد الصف الحالي للطالب
        const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
        if (userRow && userRow.parentNode) {
          userRow.parentNode.insertBefore(row, userRow.nextSibling);
          
          // تغيير نص الزر إلى "اخفاء"
          const button = userRow.querySelector('.toggle-questions-btn');
          if (button) {
            button.textContent = 'اخفاء الاسئلة';
          }
        }
      }
    }

    async function loadResults() {
      try {
        const res = await fetch("/api/results", {
          headers: { "Authorization": "Bearer " + token }
        });
        
        if (res.status === 401) { 
          logout(); 
          return; 
        }
        
        const data = await res.json();
        const table = document.getElementById("resultsTable");
        const tbody = table.querySelector("tbody");
        const stats = document.getElementById("stats");
        
        tbody.innerHTML = "";
        
        if (data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="no-results">
                No quiz results available
              </td>
            </tr>
          `;
        } else {
          // Calculate statistics
          const totalParticipants = data.length;
          const totalScore = data.reduce((sum, r) => sum + r.score, 0);
          const averageScore = Math.round(totalScore / totalParticipants);
          const highestScore = Math.max(...data.map(r => r.score));
          const lowestScore = Math.min(...data.map(r => r.score));
          
          // Update stats
          document.getElementById('totalParticipants').textContent = totalParticipants;
          document.getElementById('averageScore').textContent = `${averageScore}%`;
          document.getElementById('highestScore').textContent = `${highestScore}%`;
          document.getElementById('lowestScore').textContent = `${lowestScore}%`;
          stats.style.display = 'grid';
          
          // Populate table
          data.forEach(r => {
            const scoreClass = r.score >= 70 ? 'score-high' : 
                              r.score >= 50 ? 'score-medium' : 'score-low';
            
            const isAllowed = r.allowedRetake === true;
            const statusBadge = isAllowed 
              ? '<span class="status-badge status-allowed">Allowed</span>' 
              : '<span class="status-badge status-disallowed">Not Allowed</span>';
            
            // التأكد من وجود userAnswers
            const hasUserAnswers = r.userAnswers && Object.keys(r.userAnswers).length > 0;
            const userAnswersJson = hasUserAnswers ? JSON.stringify(r.userAnswers).replace(/'/g, "\\'") : '{}';
            
            tbody.innerHTML += `
              <tr data-user-id="${r.id}">
                <td>${r.name}</td>
                <td>${r.phone}</td>
                <td class="${scoreClass}">${r.score}%</td>
                <td>${r.correct}</td>
                <td>${r.wrong}</td>
                <td>${statusBadge}</td>
                <td class="action-cell">
                  <div class="action-buttons">
                    <button class="btn-info toggle-questions-btn" onclick="toggleQuestions('${r.id}', ${userAnswersJson})">
                      ${hasUserAnswers ? 'اظهار الاسئلة بالاجابات' : 'لا توجد إجابات'}
                    </button>
                    ${isAllowed 
                      ? `<button class="btn-warning" onclick="disallowRetake('${r.id}')">قفل</button>` 
                      : `<button class="btn-success" onclick="allowRetake('${r.id}')">فتح</button>`
                    }
                    <button class="btn-danger" onclick="deleteResult('${r.id}')">Delete</button>
                  </div>
                </td>
              </tr>
            `;
          });
        }
        
        table.classList.remove("hidden");
      } catch (error) {
        console.error("Error loading results:", error);
        alert("Failed to load results");
      }
    }

    async function allowRetake(id) {
      try {
        const res = await fetch(`/api/results/${id}/allow-retake`, {
          method: "POST",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Quiz retake allowed successfully");
          loadResults();
        } else {
          const data = await res.json();
          alert(data.message || "Failed to allow retake");
        }
      } catch (error) {
        console.error("Error allowing retake:", error);
        alert("Failed to allow retake");
      }
    }

    async function disallowRetake(id) {
      try {
        const res = await fetch(`/api/results/${id}/disallow-retake`, {
          method: "POST",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Quiz retake disallowed successfully");
          loadResults();
        } else {
          const data = await res.json();
          alert(data.message || "Failed to disallow retake");
        }
      } catch (error) {
        console.error("Error disallowing retake:", error);
        alert("Failed to disallow retake");
      }
    }

    async function deleteResult(id) {
      if (!confirm("Are you sure you want to delete this result? The user will be able to retake the quiz.")) {
        return;
      }
      
      try {
        const res = await fetch(`/api/results/${id}`, {
          method: "DELETE",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Result deleted successfully");
          loadResults();
        } else {
          const data = await res.json();
          alert(data.message || "Failed to delete result");
        }
      } catch (error) {
        console.error("Error deleting result:", error);
        alert("Failed to delete result");
      }
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    }

    // تحميل النتائج تلقائياً عند فتح الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      loadResults();
    });
  </script>
</body>
</html>
