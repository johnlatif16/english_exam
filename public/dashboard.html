<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --light: #f8f9fa;
      --dark: #343a40;
      --border-radius: 8px;
      --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      padding: 20px;
      margin: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }
    
    h2 {
      color: var(--dark);
      margin: 0;
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn-warning {
      background: var(--warning);
      color: var(--dark);
    }
    
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--box-shadow);
    }
    
    th, td {
      border: 1px solid #dee2e6;
      padding: 12px 15px;
      text-align: left;
    }
    
    th {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: rgba(0, 123, 255, 0.05);
    }
    
    .score-high {
      color: var(--success);
      font-weight: bold;
    }
    
    .score-medium {
      color: var(--warning);
      font-weight: bold;
    }
    
    .score-low {
      color: var(--danger);
      font-weight: bold;
    }
    
    .action-cell {
      width: 180px;
      text-align: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .hidden {
      display: none;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
    }
    
    .no-results {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    
    .status-allowed {
      background-color: rgba(40, 167, 69, 0.2);
      color: var(--success);
    }
    
    .status-disallowed {
      background-color: rgba(220, 53, 69, 0.2);
      color: var(--danger);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h2>Admin Dashboard</h2>
      <div class="btn-group">
        <button class="btn-primary" onclick="loadResults()">View Results</button>
        <button class="btn-danger" onclick="logout()">Logout</button>
      </div>
    </header>
    
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-label">Total Participants</div>
        <div class="stat-value" id="totalParticipants">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Average Score</div>
        <div class="stat-value" id="averageScore">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Highest Score</div>
        <div class="stat-value" id="highestScore">0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Lowest Score</div>
        <div class="stat-value" id="lowestScore">0%</div>
      </div>
    </div>
    
    <table id="resultsTable" class="hidden">
      <thead>
        <tr>
          <th>Name</th>
          <th>Phone</th>
          <th>Score (%)</th>
          <th>Correct</th>
          <th>Wrong</th>
          <th>Status</th>
          <th class="action-cell">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function verifyToken() {
  const token = localStorage.getItem("token");
  if (!token) return window.location.href = "/login.html";

  const res = await fetch("/api/verify-token", {
    headers: { Authorization: "Bearer " + token }
  });

  if (!res.ok) {
    localStorage.removeItem("token");
    window.location.href = "/login.html";
  }
}
verifyToken();

    const token = localStorage.getItem("token");
    if (!token) window.location.href = "/login.html";

    async function loadResults() {
      try {
        const res = await fetch("/api/results", {
          headers: { "Authorization": "Bearer " + token }
        });
        
        if (res.status === 401) { 
          logout(); 
          return; 
        }
        
        const data = await res.json();
        const table = document.getElementById("resultsTable");
        const tbody = table.querySelector("tbody");
        const stats = document.getElementById("stats");
        
        tbody.innerHTML = "";
        
        if (data.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="no-results">
                No quiz results available
              </td>
            </tr>
          `;
        } else {
          // Calculate statistics
          const totalParticipants = data.length;
          const totalScore = data.reduce((sum, r) => sum + r.score, 0);
          const averageScore = Math.round(totalScore / totalParticipants);
          const highestScore = Math.max(...data.map(r => r.score));
          const lowestScore = Math.min(...data.map(r => r.score));
          
          // Update stats
          document.getElementById('totalParticipants').textContent = totalParticipants;
          document.getElementById('averageScore').textContent = `${averageScore}%`;
          document.getElementById('highestScore').textContent = `${highestScore}%`;
          document.getElementById('lowestScore').textContent = `${lowestScore}%`;
          stats.style.display = 'grid';
          
          // Populate table
          data.forEach(r => {
            const scoreClass = r.score >= 70 ? 'score-high' : 
                              r.score >= 50 ? 'score-medium' : 'score-low';
            
            const isAllowed = r.allowedRetake === true;
            const statusBadge = isAllowed 
              ? '<span class="status-badge status-allowed">Allowed</span>' 
              : '<span class="status-badge status-disallowed">Not Allowed</span>';
            
            tbody.innerHTML += `
              <tr>
                <td>${r.name}</td>
                <td>${r.phone}</td>
                <td class="${scoreClass}">${r.score}</td>
                <td>${r.correct}</td>
                <td>${r.wrong}</td>
                <td>${statusBadge}</td>
                <td class="action-cell">
                  <div class="action-buttons">
                    ${isAllowed 
                      ? `<button class="btn-warning" onclick="disallowRetake('${r.id}')">قفل</button>` 
                      : `<button class="btn-success" onclick="allowRetake('${r.id}')">فتح</button>`
                    }
                    <button class="btn-danger" onclick="deleteResult('${r.id}')">Delete</button>
                  </div>
                </td>
              </tr>
            `;
          });
        }
        
        table.classList.remove("hidden");
      } catch (error) {
        console.error("Error loading results:", error);
        alert("Failed to load results");
      }
    }

    async function allowRetake(id) {
      try {
        const res = await fetch(`/api/results/${id}/allow-retake`, {
          method: "POST",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Quiz retake allowed successfully");
          loadResults(); // Refresh the table
        } else {
          const data = await res.json();
          alert(data.message || "Failed to allow retake");
        }
      } catch (error) {
        console.error("Error allowing retake:", error);
        alert("Failed to allow retake");
      }
    }

    async function disallowRetake(id) {
      try {
        const res = await fetch(`/api/results/${id}/disallow-retake`, {
          method: "POST",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Quiz retake disallowed successfully");
          loadResults(); // Refresh the table
        } else {
          const data = await res.json();
          alert(data.message || "Failed to disallow retake");
        }
      } catch (error) {
        console.error("Error disallowing retake:", error);
        alert("Failed to disallow retake");
      }
    }

    async function deleteResult(id) {
      if (!confirm("Are you sure you want to delete this result? The user will be able to retake the quiz.")) {
        return;
      }
      
      try {
        const res = await fetch(`/api/results/${id}`, {
          method: "DELETE",
          headers: { 
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        if (res.ok) {
          alert("Result deleted successfully");
          loadResults(); // Refresh the table
        } else {
          const data = await res.json();
          alert(data.message || "Failed to delete result");
        }
      } catch (error) {
        console.error("Error deleting result:", error);
        alert("Failed to delete result");
      }
    }

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "/login.html";
    }
  </script>
</body>
</html>
